# IPMI Auto-Cabling Service for NetBox

Сервис автоматически создает кабельные соединения (Cables) в NetBox между OOB-интерфейсами серверов (IPMI/BMC/iDRAC) и портами коммутаторов, основываясь на данных FDB/MAC-таблиц.

## Как это работает

```
┌─────────────┐         ┌──────────────┐         ┌─────────────┐
│   NetBox    │◄────────│   Сервис     │────────►│  Коммутатор │
│  (API)      │         │              │  SNMP   │  (FDB table)│
└─────────────┘         └──────────────┘         └─────────────┘
     │                        │
     │ 1. Список серверов     │ 3. MAC → порт
     │    с OOB IP            │
     │ 2. Список коммутаторов │ 4. Создание Cable
     │    по роли/сайту       │
     ▼                        ▼
```

### Алгоритм работы

1. **Сбор серверов** — находит все устройства в NetBox с заполненным OOB IP, получает MAC-адрес OOB-интерфейса.
2. **Сбор коммутаторов** — находит коммутаторы по роли (`SWITCHES_ROLE`) на тех же сайтах, где находятся серверы.
3. **Опрос FDB** — по SNMP собирает MAC-таблицу с каждого коммутатора (поддерживаются Huawei, стандартные Q-Bridge и Bridge MIB).
4. **Корреляция** — сопоставляет MAC-адреса IPMI с портами коммутаторов.
5. **Фильтрация** — исключает uplink/trunk порты (по имени, описанию, паттернам).
6. **Стабильность** — MAC должен быть найден на одном и том же порту N запусков подряд (anti-flap).
7. **Создание Cable** — если все проверки пройдены и оба termination свободны, создает кабель в NetBox.

### Безопасность

- Никогда не удаляет и не изменяет существующие кабели
- Не подключает, если termination занята
- Идемпотентность — повторный запуск не создает дубликаты
- Dry-run режим для тестирования

---

## Требования к NetBox

### Серверы

Для каждого сервера, который должен быть обработан:

| Поле | Где | Обязательно | Описание |
|------|-----|:-----------:|----------|
| OOB IP | Device → OOB IP | Да | IP-адрес OOB-интерфейса (любой, нужен для идентификации) |
| Интерфейс | Interfaces | Да | Интерфейс, к которому привязан OOB IP |
| MAC-адрес | Interface → MAC Address | Да | MAC-адрес OOB-интерфейса (по нему ищем в FDB) |
| Cable | Interface → Cable | Нет | Должен быть **пустым** (если уже есть — пропускается) |

**Как заполнить:**
1. Создать интерфейс (имя: `IPMI`, `BMC`, `MGMT`, `iLO`, `iDRAC` и т.п.)
2. Указать MAC-адрес этого интерфейса
3. Создать IP-адрес и назначить его на этот интерфейс
4. В настройках устройства указать этот IP как **OOB IP**

### Коммутаторы

| Поле | Где | Обязательно | Описание |
|------|-----|:-----------:|----------|
| Role | Device → Role | Да | Роль устройства (должна совпадать с `SWITCHES_ROLE`) |
| Site | Device → Site | Да | Сайт (автоматически фильтруется по сайтам серверов) |
| Primary IP | Device → Primary IP | Да | IP для SNMP-опроса |
| Интерфейсы | Interfaces | Да | Порты коммутатора (имена должны совпадать с SNMP ifName) |

**Важно:** Имена интерфейсов в NetBox должны соответствовать тому, что отдает SNMP. Сервис поддерживает автоматическую конвертацию между полными и сокращенными именами:

| SNMP (ifName) | NetBox (варианты) |
|---------------|-------------------|
| `GigabitEthernet0/0/1` | `GE0/0/1` |
| `XGigabitEthernet1/0/1` | `10GE1/0/1` |
| `TenGigabitEthernet1/1` | `Te1/1` |
| `FastEthernet0/1` | `Fa0/1` |

---

## Установка и запуск

### Docker (рекомендуемый способ)

1. Скопировать проект на сервер:
```bash
git clone <repo-url> /opt/netbox_autocabling
cd /opt/netbox_autocabling
```

2. Создать `.env` файл (на основе `.env.example`):
```bash
cp .env.example .env
nano .env
```

3. Собрать образ:
```bash
docker build -t ipmi-autocabling:1.0.4 .
```

4. Запустить:
```bash
docker compose up -d
```

5. Проверить логи:
```bash
docker logs -f ipmi-autocabling
```

### Локально (без Docker)

```bash
# Создать виртуальное окружение
python3 -m venv venv
source venv/bin/activate

# Установить зависимости
pip install -r requirements.txt

# Настроить .env
cp .env.example .env
nano .env

# Запуск (one-shot)
python3 -m src.ipmi_autocabling --log-level DEBUG

# Запуск (daemon)
python3 -m src.ipmi_autocabling --daemon --log-level INFO
```

---

## Конфигурация (.env)

### Подключение к NetBox

| Переменная | Описание | Пример |
|-----------|----------|--------|
| `NETBOX_URL` | URL NetBox API | `https://netbox.example.com` |
| `NETBOX_TOKEN` | API токен (с правами на чтение устройств/интерфейсов и создание кабелей) | `0123456789abcdef` |
| `NETBOX_VERIFY_SSL` | Проверка SSL-сертификата | `false` |

### Фильтрация устройств

| Переменная | Описание | Пример |
|-----------|----------|--------|
| `SWITCHES_ROLE` | Роль коммутаторов в NetBox (slug) | `oam-switch` |

> **Site** определяется автоматически: сервис находит серверы с OOB IP, определяет их сайты, и ищет коммутаторы только на этих сайтах.

### SNMP

| Переменная | Описание | По умолчанию |
|-----------|----------|:------------:|
| `SNMP_COMMUNITY` | SNMP community string | `public` |
| `SNMP_VERSION` | Версия SNMP | `2c` |
| `SNMP_TIMEOUT` | Таймаут запроса (сек) | `5` |
| `SNMP_RETRIES` | Количество повторов | `2` |

### Фильтрация портов

| Переменная | Описание | Пример |
|-----------|----------|--------|
| `UPLINK_PORTS` | Список портов-исключений (через запятую) | `Ethernet49,Ethernet50` |
| `UPLINK_PATTERNS` | Regex-паттерны для исключения по описанию порта | `uplink,trunk,to[-_]?spine` |

### Режим работы

| Переменная | Описание | По умолчанию |
|-----------|----------|:------------:|
| `POLL_INTERVAL` | Интервал опроса в секундах (0 = one-shot) | `0` |
| `STABILITY_RUNS` | Сколько раз MAC должен быть найден на одном порту | `2` |
| `DRY_RUN` | Режим тестирования (не создает кабели) | `false` |
| `CABLE_STATUS` | Статус создаваемого кабеля | `planned` |
| `STATE_DB_PATH` | Путь к файлу базы состояния | `state.db` |

### MLAG

| Переменная | Описание | Пример |
|-----------|----------|--------|
| `MLAG_GROUPS` | Пары MLAG-коммутаторов | `switch1:switch2,switch3:switch4` |

---

## Режимы запуска

### One-shot (одноразовый)

```
POLL_INTERVAL=0
```

Сервис выполняет один проход и завершается. Подходит для cron-задач.

Exit codes:
- `0` — успех
- `1` — фатальная ошибка
- `2` — частичные ошибки

### Daemon (постоянный)

```
POLL_INTERVAL=300
```

Сервис работает постоянно, опрашивая коммутаторы каждые N секунд. При `STABILITY_RUNS=2` кабель будет создан после 2-го успешного обнаружения MAC на том же порту (через ~10 минут при интервале 300 сек).

---

## Статусы обработки MAC-адресов

| Статус | Описание |
|--------|----------|
| `CREATED` | Кабель успешно создан |
| `EXISTS` | Кабель уже существует (пропуск) |
| `PENDING` | MAC найден, ожидание стабильности (N/STABILITY_RUNS) |
| `SKIP_NON_ACCESS` | Порт определен как uplink/trunk (пропуск) |
| `AMBIGUOUS` | MAC найден на нескольких портах/коммутаторах |
| `NOT_FOUND` | MAC не найден ни в одной FDB-таблице |
| `ERROR` | Ошибка (интерфейс не найден в NetBox, API ошибка и т.д.) |

---

## Troubleshooting

### pysnmp not installed

```
[WARNING] pysnmp not installed. FDB collection will use mock data.
```

Установите совместимую версию:
```bash
pip install "pysnmp-lextudio>=5.0.0,<6.0.0" "pyasn1>=0.4.8,<0.6.0"
```

### Interface not found on switch

```
[ERROR] Interface GigabitEthernet0/0/22 not found on SW-OAM1
```

Имя интерфейса в SNMP не совпадает с именем в NetBox. Проверьте:
- Как назван интерфейс в NetBox (например `GE0/0/22` vs `GigabitEthernet0/0/22`)
- Сервис автоматически пробует варианты (GE ↔ GigabitEthernet и т.д.)
- Если имена сильно отличаются — переименуйте интерфейсы в NetBox

### MAC not found in FDB

```
[INFO] server01:IPMI - MAC not found in FDB
```

Возможные причины:
- Коммутатор, к которому подключен сервер, не в списке (не та роль/сайт)
- SNMP community неправильный
- Сервер выключен (MAC не в FDB)
- Коммутатор не доступен по SNMP с хоста сервиса

### Контейнер сразу останавливается

`POLL_INTERVAL=0` — one-shot режим. Установите `POLL_INTERVAL=300` для постоянной работы.

### Stability counter не увеличивается (всегда 1/N)

State database не персистится. Убедитесь:
- `STATE_DB_PATH=/data/state.db`
- Volume смонтирован: `./data:/data`
- Не используется `docker run --rm` без volume

---

## Создаваемый кабель в NetBox

При создании кабеля:
- **Termination A**: OOB-интерфейс сервера
- **Termination B**: порт коммутатора
- **Status**: значение из `CABLE_STATUS` (planned/connected)
- **Label**: `autocabling:ipmi`

---

## Структура проекта

```
src/ipmi_autocabling/
├── __main__.py        # Точка входа, CLI аргументы
├── config.py          # Конфигурация из env
├── service.py         # Основной цикл
├── netbox_client.py   # Работа с NetBox API
├── fdb_collector.py   # Сбор FDB через SNMP
├── port_classifier.py # Фильтрация uplink/trunk портов
├── correlator.py      # Сопоставление MAC → порт
├── state_db.py        # SQLite база состояния
├── mac_utils.py       # Утилиты для MAC-адресов
└── logging_config.py  # Настройка логирования
```
